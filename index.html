<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√ºrkiye ƒ∞≈ü Cinayetleri Haritasƒ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
        }

        #header {
            background: linear-gradient(135deg, #c0392b 0%, #8e44ad 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        #header p {
            font-size: 14px;
            opacity: 0.9;
        }

        #controls {
            background: white;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-group select:hover {
            border-color: #c0392b;
        }

        .filter-group input[type="number"] {
            transition: border-color 0.3s;
        }

        .filter-group input[type="number"]:hover {
            border-color: #3498db;
        }

        .filter-group input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .filter-group button:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .filter-group button:active {
            transform: translateY(0);
        }

        #loadGithubData:hover {
            background: #c0392b !important;
        }

        #loadGithubData:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #map {
            width: 100%;
            height: calc(100vh - 160px);
        }

        .custom-marker {
            background-color: #c0392b;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .custom-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }

        .marker-low { background-color: #f39c12; }
        .marker-medium { background-color: #e67e22; }
        .marker-high { background-color: #c0392b; }
        .marker-critical { background-color: #8e44ad; }

        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
        }

        .popup-title {
            font-size: 18px;
            font-weight: bold;
            color: #c0392b;
            margin-bottom: 10px;
            border-bottom: 2px solid #c0392b;
            padding-bottom: 5px;
        }

        .popup-info {
            margin: 8px 0;
            line-height: 1.8;
        }

        .popup-info strong {
            color: #333;
        }

        .popup-info br + * {
            margin-left: 0;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 1.8;
        }

        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin-top: 10px;
        }

        .stats h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .stat-item {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Cluster marker styles */
        .marker-cluster-custom {
            background: linear-gradient(135deg, #c0392b 0%, #8e44ad 100%);
            border: 4px solid #fff;
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            transition: transform 0.2s;
        }

        .marker-cluster-custom:hover {
            transform: scale(1.1);
        }

        .marker-cluster-custom div {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        .cluster-count {
            font-size: 24px;
            font-weight: bold;
        }

        .cluster-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: -2px;
        }

        /* Checkbox styles */
        .filter-group input[type="checkbox"] {
            transition: transform 0.2s;
        }

        .filter-group input[type="checkbox"]:hover {
            transform: scale(1.15);
        }

        .filter-group label:has(input[type="checkbox"]) {
            transition: color 0.2s;
        }

        .filter-group label:has(input[type="checkbox"]):hover {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üèóÔ∏è T√ºrkiye ƒ∞≈ü Cinayetleri Haritasƒ±</h1>
        <p>GitHub'dan g√ºncel veri y√ºkleyin veya kendi Excel/CSV dosyanƒ±zƒ± kullanƒ±n</p>
    </div>

    <div id="controls">
        <div class="filter-group">
            <label for="fileUpload" style="cursor: pointer; background: #27ae60; color: white; padding: 8px 15px; border-radius: 5px; font-weight: 600;">
                üìÅ Dosya Y√ºkle (Excel/CSV)
            </label>
            <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv" style="display: none;">
            <span id="fileName" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
        </div>
        <div class="filter-group">
            <button id="loadGithubData" style="padding: 8px 15px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                üìä GitHub'dan Veri Y√ºkle
            </button>
        </div>
        <div class="filter-group">
            <label for="citySearch">üîç ƒ∞l Ara:</label>
            <input type="text" id="citySearch" placeholder="ƒ∞l adƒ± yazƒ±n..." style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; min-width: 200px;">
            <button id="searchBtn" style="padding: 8px 20px; background: #c0392b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Ara</button>
        </div>
        <div class="filter-group">
            <label for="startYear">Ba≈ülangƒ±√ß Yƒ±lƒ±:</label>
            <input type="number" id="startYear" min="2000" max="2030" value="2025" placeholder="2025" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px;">
        </div>
        <div class="filter-group">
            <label for="endYear">Biti≈ü Yƒ±lƒ±:</label>
            <input type="number" id="endYear" min="2000" max="2030" value="2025" placeholder="2025" style="padding: 8px 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 100px;">
        </div>
        <div class="filter-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                <input type="checkbox" id="allYears" style="cursor: pointer; width: 18px; height: 18px; accent-color: #3498db;">
                T√ºm√º
            </label>
        </div>
        <div class="filter-group">
            <button id="applyYearFilter" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Uygula</button>
        </div>
        <div class="filter-group">
            <label for="sectorFilter">Sekt√∂r:</label>
            <select id="sectorFilter">
                <option value="all">T√ºm√º</option>
                <option value="insaat">ƒ∞n≈üaat</option>
                <option value="maden">Madencilik</option>
                <option value="tarim">Tarƒ±m</option>
                <option value="imalat">ƒ∞malat</option>
                <option value="lojistik">Lojistik</option>
            </select>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Harita ba≈ülangƒ±√ß ayarlarƒ± - Sakarya merkezli
        const map = L.map('map').setView([40.7569, 30.4003], 10);

        // OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18,
        }).addTo(map);

        // Excel dosyasƒ±ndaki her olay ayrƒ± marker olarak g√∂sterilir
        // Yeni dosya y√ºkleyerek bu veriyi deƒüi≈ütirebilirsiniz
        let workplaceAccidents = [
            { city: 'Serdivan, Sakarya', lat: 40.7904, lng: 30.3619, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Y√ºksekten d√º≈üme', date: '2024-01-15', name: '√ñrnek √áalƒ±≈üan' },
            { city: 'Adapazarƒ±, Sakarya', lat: 40.7731, lng: 30.4000, count: 3, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-02-14', name: 'Adapazarƒ± √ñrnek 1' },
            { city: 'Adapazarƒ±, Sakarya', lat: 40.7731, lng: 30.4000, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Elektrik √ßarpmasƒ±', date: '2024-05-18', name: 'Adapazarƒ± √ñrnek 2' },
            { city: 'Serdivan, Sakarya', lat: 40.7781, lng: 30.3540, count: 3, sector: 'imalat', sectorName: 'ƒ∞malat', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-06-16', name: 'Serdivan √ñrnek 1' },
            { city: 'Serdivan, Sakarya', lat: 40.7781, lng: 30.3540, count: 3, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Y√ºksekten d√º≈üme', date: '2024-06-19', name: 'Serdivan √ñrnek 2' },
            { city: 'Erenler, Sakarya', lat: 40.7569, lng: 30.4023, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-04-05', name: 'Erenler √ñrnek 1' },
            { city: 'Erenler, Sakarya', lat: 40.7569, lng: 30.4023, count: 3, sector: 'imalat', sectorName: 'ƒ∞malat', reason: 'Y√ºksekten d√º≈üme', date: '2024-04-24', name: 'Erenler √ñrnek 2' },
            { city: 'Arifiye, Sakarya', lat: 40.7140, lng: 30.3960, count: 3, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-01-03', name: 'Arifiye √ñrnek 1' },
            { city: 'Arifiye, Sakarya', lat: 40.7140, lng: 30.3960, count: 1, sector: 'maden', sectorName: 'Madencilik', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-05-02', name: 'Arifiye √ñrnek 2' },
            { city: 'Sapanca, Sakarya', lat: 40.6910, lng: 30.2670, count: 2, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Servis aracƒ± kazasƒ±', date: '2024-02-23', name: 'Sapanca √ñrnek 1' },
            { city: 'Sapanca, Sakarya', lat: 40.6910, lng: 30.2670, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Malzeme √ßarpmasƒ±', date: '2024-03-26', name: 'Sapanca √ñrnek 2' },
            { city: 'Akyazƒ±, Sakarya', lat: 40.6865, lng: 30.6227, count: 1, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Servis aracƒ± kazasƒ±', date: '2024-06-12', name: 'Akyazƒ± √ñrnek 1' },
            { city: 'Akyazƒ±, Sakarya', lat: 40.6865, lng: 30.6227, count: 2, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Y√ºksekten d√º≈üme', date: '2024-06-21', name: 'Akyazƒ± √ñrnek 2' },
            { city: 'Hendek, Sakarya', lat: 40.7994, lng: 30.7486, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Y√ºksekten d√º≈üme', date: '2024-03-30', name: 'Hendek √ñrnek 1' },
            { city: 'Hendek, Sakarya', lat: 40.7994, lng: 30.7486, count: 1, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Elektrik √ßarpmasƒ±', date: '2024-06-11', name: 'Hendek √ñrnek 2' },
            { city: 'Karasu, Sakarya', lat: 41.0711, lng: 30.7860, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Elektrik √ßarpmasƒ±', date: '2024-04-30', name: 'Karasu √ñrnek 1' },
            { city: 'Karasu, Sakarya', lat: 41.0711, lng: 30.7860, count: 1, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-01-05', name: 'Karasu √ñrnek 2' },
            { city: 'Kocaali, Sakarya', lat: 41.0531, lng: 30.8500, count: 1, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Servis aracƒ± kazasƒ±', date: '2024-01-29', name: 'Kocaali √ñrnek 1' },
            { city: 'Kocaali, Sakarya', lat: 41.0531, lng: 30.8500, count: 2, sector: 'maden', sectorName: 'Madencilik', reason: 'Y√ºksekten d√º≈üme', date: '2024-01-12', name: 'Kocaali √ñrnek 2' },
            { city: 'Pamukova, Sakarya', lat: 40.5119, lng: 30.1677, count: 3, sector: 'maden', sectorName: 'Madencilik', reason: 'Servis aracƒ± kazasƒ±', date: '2024-05-27', name: 'Pamukova √ñrnek 1' },
            { city: 'Pamukova, Sakarya', lat: 40.5119, lng: 30.1677, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Servis aracƒ± kazasƒ±', date: '2024-04-13', name: 'Pamukova √ñrnek 2' },
            { city: 'Geyve, Sakarya', lat: 40.5075, lng: 30.2925, count: 1, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Elektrik √ßarpmasƒ±', date: '2024-06-06', name: 'Geyve √ñrnek 1' },
            { city: 'Geyve, Sakarya', lat: 40.5075, lng: 30.2925, count: 1, sector: 'lojistik', sectorName: 'Lojistik', reason: 'Makine sƒ±kƒ±≈ümasƒ±', date: '2024-06-29', name: 'Geyve √ñrnek 2' },
            { city: 'Taraklƒ±, Sakarya', lat: 40.3961, lng: 30.4931, count: 5, sector: 'imalat', sectorName: 'ƒ∞malat', reason: 'Malzeme √ßarpmasƒ±', date: '2024-03-14', name: 'Taraklƒ± √ñrnek 1' },
            { city: 'Taraklƒ±, Sakarya', lat: 40.3961, lng: 30.4931, count: 2, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Y√ºksekten d√º≈üme', date: '2024-04-04', name: 'Taraklƒ± √ñrnek 2' },
            { city: 'S√∂ƒü√ºtl√º, Sakarya', lat: 40.9020, lng: 30.4440, count: 1, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Servis aracƒ± kazasƒ±', date: '2024-04-13', name: 'S√∂ƒü√ºtl√º √ñrnek 1' },
            { city: 'S√∂ƒü√ºtl√º, Sakarya', lat: 40.9020, lng: 30.4440, count: 1, sector: 'imalat', sectorName: 'ƒ∞malat', reason: 'Servis aracƒ± kazasƒ±', date: '2024-06-28', name: 'S√∂ƒü√ºtl√º √ñrnek 2' },
            { city: 'Ferizli, Sakarya', lat: 40.9400, lng: 30.4830, count: 2, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Y√ºksekten d√º≈üme', date: '2024-04-15', name: 'Ferizli √ñrnek 1' },
            { city: 'Ferizli, Sakarya', lat: 40.9400, lng: 30.4830, count: 1, sector: 'tarim', sectorName: 'Tarƒ±m', reason: 'Y√ºksekten d√º≈üme', date: '2024-04-15', name: 'Ferizli √ñrnek 2' },
            { city: 'Kaynarca, Sakarya', lat: 41.0345, lng: 30.3115, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Y√ºksekten d√º≈üme', date: '2024-06-18', name: 'Kaynarca √ñrnek 1' },
            { city: 'Kaynarca, Sakarya', lat: 41.0345, lng: 30.3115, count: 1, sector: 'insaat', sectorName: 'ƒ∞n≈üaat', reason: 'Malzeme √ßarpmasƒ±', date: '2024-01-11', name: 'Kaynarca √ñrnek 2' }
        ];

        let markers = [];
        let markerClusterGroup;

        // GitHub'dan veri y√ºkleme fonksiyonu
        async function loadGithubData() {
            const githubUrl = 'https://raw.githubusercontent.com/suacalis/is_cinayetleri/refs/heads/main/veri_turkiye.csv';
            const button = document.getElementById('loadGithubData');
            
            try {
                // Buton durumunu deƒüi≈ütir
                button.disabled = true;
                button.textContent = '‚è≥ Y√ºkleniyor...';
                button.style.background = '#95a5a6';
                
                // CSV dosyasƒ±nƒ± fetch et
                const response = await fetch(githubUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                // CSV'yi parse et
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] ? values[index].trim() : '';
                        });
                        data.push(row);
                    }
                }
                
                // Veriyi harita formatƒ±na d√∂n√º≈üt√ºr
                const newAccidents = parseUploadedData(data);
                
                if (newAccidents.length > 0) {
                    // Global veriyi g√ºncelle
                    workplaceAccidents.length = 0;
                    workplaceAccidents.push(...newAccidents);
                    
                    // Haritayƒ± g√ºncelle - t√ºm yƒ±llarƒ± g√∂ster
                    document.getElementById('allYears').checked = true;
                    toggleYearInputs();
                    filterData();
                    
                    // Ba≈üarƒ± mesajƒ±
                    alert(`‚úÖ Ba≈üarƒ±lƒ±! GitHub'dan ${newAccidents.length} olay y√ºklendi.\nToplam ${newAccidents.reduce((sum, acc) => sum + acc.count, 0)} √∂l√º.`);
                    
                    // Dosya adƒ±nƒ± g√∂ster
                    document.getElementById('fileName').textContent = 'Y√ºklendi: veri_turkiye.csv (GitHub)';
                } else {
                    alert('‚ùå GitHub verisinde ge√ßerli veri bulunamadƒ±.');
                }
                
            } catch (error) {
                console.error('GitHub veri y√ºkleme hatasƒ±:', error);
                alert(`‚ùå GitHub'dan veri y√ºklenirken hata olu≈ütu:\n${error.message}\n\nL√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.`);
            } finally {
                // Buton durumunu eski haline getir
                button.disabled = false;
                button.textContent = 'üìä GitHub\'dan Veri Y√ºkle';
                button.style.background = '#e74c3c';
            }
        }

        // Dosya y√ºkleme ve i≈üleme fonksiyonu
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya adƒ±nƒ± g√∂ster
            document.getElementById('fileName').textContent = `Y√ºklendi: ${file.name}`;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();

                    if (fileName.endsWith('.csv')) {
                        // CSV dosyasƒ± i≈üleme
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',');
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : '';
                                });
                                data.push(row);
                            }
                        }
                    } else {
                        // Excel dosyasƒ± i≈üleme
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        data = XLSX.utils.sheet_to_json(worksheet);
                    }

                    // Veriyi harita formatƒ±na d√∂n√º≈üt√ºr
                    const newAccidents = parseUploadedData(data);
                    
                    if (newAccidents.length > 0) {
                        // Global veriyi g√ºncelle
                        workplaceAccidents.length = 0;
                        workplaceAccidents.push(...newAccidents);
                        
                        // Haritayƒ± g√ºncelle
                        filterData();
                        
                        alert(`Ba≈üarƒ±lƒ±! ${newAccidents.length} olay y√ºklendi. Toplam ${newAccidents.reduce((sum, acc) => sum + acc.count, 0)} √∂l√º.`);
                    } else {
                        alert('Dosyada ge√ßerli veri bulunamadƒ±. L√ºtfen dosya formatƒ±nƒ± kontrol edin.');
                    }
                } catch (error) {
                    console.error('Dosya okuma hatasƒ±:', error);
                    alert('Dosya i≈ülenirken hata olu≈ütu: ' + error.message);
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // Y√ºklenen veriyi parse etme fonksiyonu
        function parseUploadedData(data) {
            const sectorMap = {
                'ƒ∞n≈üaat': 'insaat',
                'insaat': 'insaat',
                'Tarƒ±m': 'tarim',
                'tarim': 'tarim',
                'ƒ∞malat': 'imalat',
                'imalat': 'imalat',
                'Lojistik': 'lojistik',
                'lojistik': 'lojistik',
                'Madencilik': 'maden',
                'maden': 'maden',
                'Maden': 'maden'
            };

            const accidents = [];

            data.forEach(row => {
                // Kolon adlarƒ±nƒ± esnek ≈üekilde kontrol et (b√ºy√ºk/k√º√ß√ºk harf duyarsƒ±z)
                const keys = Object.keys(row);
                const getColumn = (possibleNames) => {
                    const key = keys.find(k => 
                        possibleNames.some(name => 
                            k.toLowerCase().includes(name.toLowerCase())
                        )
                    );
                    return key ? row[key] : null;
                };

                const city = getColumn(['yer', 'city', 'sehir', 'il']);
                const lat = parseFloat(getColumn(['lat', 'latitude', 'enlem']));
                const lng = parseFloat(getColumn(['lng', 'longitude', 'boylam', 'long']));
                const count = parseInt(getColumn(['olum_sayisi', 'olu', 'count', 'death'])) || 1;
                const sector = getColumn(['sektor', 'sector']);
                const reason = getColumn(['neden', 'reason', 'sebep']);
                const name = getColumn(['isim', 'name', 'ad']);
                const date = getColumn(['tarih', 'date']);

                // Ge√ßerlilik kontrol√º
                if (city && !isNaN(lat) && !isNaN(lng) && sector) {
                    const sectorCode = sectorMap[sector] || 'diger';
                    const sectorName = sector.charAt(0).toUpperCase() + sector.slice(1);

                    accidents.push({
                        city: city,
                        lat: lat,
                        lng: lng,
                        count: count,
                        sector: sectorCode,
                        sectorName: sectorName,
                        reason: reason || 'Belirtilmemi≈ü',
                        date: date || '',
                        name: name || ''
                    });
                }
            });

            return accidents;
        }

        // Marker cluster grubu olu≈ütur
        function createClusterGroup() {
            return L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    // Cluster i√ßindeki t√ºm markerlarƒ±n √∂l√ºm sayƒ±sƒ±nƒ± topla
                    const markers = cluster.getAllChildMarkers();
                    const totalDeaths = markers.reduce((sum, marker) => {
                        return sum + (marker.options.deathCount || 0);
                    }, 0);

                    // Cluster boyutunu √∂l√ºm sayƒ±sƒ±na g√∂re belirle
                    let size = 60;
                    if (totalDeaths >= 30) size = 80;
                    else if (totalDeaths >= 20) size = 70;
                    else if (totalDeaths >= 10) size = 60;
                    else size = 50;

                    return L.divIcon({
                        html: `<div class="marker-cluster-custom" style="width: ${size}px; height: ${size}px;">
                                <div>
                                    <div class="cluster-count">${totalDeaths}</div>
                                </div>
                               </div>`,
                        className: '',
                        iconSize: L.point(size, size)
                    });
                },
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 80
            });
        }

        // Marker boyutunu ve rengini belirleme fonksiyonu
        function getMarkerSize(count) {
            if (count >= 5) return { size: 50, class: 'marker-critical' };
            if (count >= 3) return { size: 45, class: 'marker-high' };
            if (count >= 2) return { size: 40, class: 'marker-medium' };
            return { size: 35, class: 'marker-low' };
        }

        // Markerlarƒ± haritaya ekleme
        function addMarkers(data) {
            // √ñnceki cluster grubunu kaldƒ±r
            if (markerClusterGroup) {
                map.removeLayer(markerClusterGroup);
            }
            
            // Yeni cluster grubu olu≈ütur
            markerClusterGroup = createClusterGroup();
            markers = [];

            data.forEach(accident => {
                const { size, class: markerClass } = getMarkerSize(accident.count);
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-marker ${markerClass}" style="width: ${size}px; height: ${size}px;">${accident.count}</div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });

                const marker = L.marker([accident.lat, accident.lng], { 
                    icon: icon,
                    deathCount: accident.count // √ñl√ºm sayƒ±sƒ±nƒ± marker'a ekle
                })
                    .bindPopup(`
                        <div class="popup-title">${accident.city}</div>
                        <div class="popup-info"><strong>√ñl√º Sayƒ±sƒ±:</strong> ${accident.count}</div>
                        <div class="popup-info"><strong>Sekt√∂r:</strong> ${accident.sectorName}</div>
                        <div class="popup-info"><strong>Neden:</strong> ${accident.reason}</div>
                    `);

                markers.push(marker);
                markerClusterGroup.addLayer(marker); // Cluster grubuna ekle
            });

            // Cluster grubunu haritaya ekle
            map.addLayer(markerClusterGroup);
            
            updateStats(data);
        }

        // Sekt√∂r adƒ±nƒ± getir
        function getSectorName(sector) {
            const sectors = {
                'insaat': 'ƒ∞n≈üaat',
                'maden': 'Madencilik',
                'tarim': 'Tarƒ±m',
                'imalat': 'ƒ∞malat',
                'lojistik': 'Lojistik'
            };
            return sectors[sector] || sector;
        }

        // Filtreleme fonksiyonu
        function filterData() {
            const sectorFilter = document.getElementById('sectorFilter').value;
            const allYears = document.getElementById('allYears').checked;
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            
            let filteredData = workplaceAccidents;

            // Sekt√∂r filtresi
            if (sectorFilter !== 'all') {
                filteredData = filteredData.filter(accident => accident.sector === sectorFilter);
            }

            // Yƒ±l aralƒ±ƒüƒ± filtresi (sadece "T√ºm√º" se√ßili deƒüilse)
            if (!allYears && !isNaN(startYear) && !isNaN(endYear)) {
                filteredData = filteredData.filter(accident => {
                    if (!accident.date) return true; // Tarih yoksa g√∂ster
                    const year = parseInt(accident.date.toString().substring(0, 4));
                    return year >= startYear && year <= endYear;
                });
            }

            addMarkers(filteredData);
        }

        // Yƒ±l input'larƒ±nƒ± aktif/pasif yapma
        function toggleYearInputs() {
            const allYears = document.getElementById('allYears').checked;
            const startYearInput = document.getElementById('startYear');
            const endYearInput = document.getElementById('endYear');
            
            startYearInput.disabled = allYears;
            endYearInput.disabled = allYears;
            
            if (allYears) {
                startYearInput.style.opacity = '0.5';
                endYearInput.style.opacity = '0.5';
                startYearInput.style.cursor = 'not-allowed';
                endYearInput.style.cursor = 'not-allowed';
            } else {
                startYearInput.style.opacity = '1';
                endYearInput.style.opacity = '1';
                startYearInput.style.cursor = 'text';
                endYearInput.style.cursor = 'text';
            }
        }

        // ƒ∞statistikleri g√ºncelle
        function updateStats(data) {
            const totalDeaths = data.reduce((sum, accident) => sum + accident.count, 0);
            const avgPerIncident = (totalDeaths / data.length).toFixed(1);
            
            // Mevcut istatistik panelini kaldƒ±r
            const existingStats = document.querySelector('.leaflet-control.stats');
            if (existingStats) {
                existingStats.remove();
            }

            // Yeni istatistik paneli olu≈ütur
            const statsControl = L.control({ position: 'topright' });
            statsControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'stats');
                div.innerHTML = `
                    <h4>üìä ƒ∞statistikler</h4>
                    <div class="stat-item"><strong>Toplam √ñl√ºm:</strong> ${totalDeaths}</div>
                    <div class="stat-item"><strong>Olay Sayƒ±sƒ±:</strong> ${data.length}</div>
                    <div class="stat-item"><strong>Olay Ba≈üƒ±na Ort:</strong> ${avgPerIncident}</div>
                `;
                return div;
            };
            statsControl.addTo(map);
        }

        // ƒ∞l arama fonksiyonu
        function searchCity() {
            const searchTerm = document.getElementById('citySearch').value.trim();
            
            if (!searchTerm) {
                alert('L√ºtfen bir il adƒ± girin!');
                return;
            }

            // T√ºrk√ße karakterleri normalize et
            const normalizeText = (text) => {
                return text.toLowerCase()
                    .replace(/ƒü/g, 'g')
                    .replace(/√º/g, 'u')
                    .replace(/≈ü/g, 's')
                    .replace(/ƒ±/g, 'i')
                    .replace(/√∂/g, 'o')
                    .replace(/√ß/g, 'c');
            };

            const normalizedSearch = normalizeText(searchTerm);

            // ≈ûehri bul
            const foundCity = workplaceAccidents.find(accident => 
                normalizeText(accident.city).includes(normalizedSearch)
            );

            if (foundCity) {
                // Haritayƒ± ≈üehre odakla (zoom seviyesini artƒ±r)
                map.setView([foundCity.lat, foundCity.lng], 13);
                
                // ƒ∞lgili marker'ƒ± bul ve popup'ƒ± a√ß
                setTimeout(() => {
                    markers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (Math.abs(markerLatLng.lat - foundCity.lat) < 0.001 && 
                            Math.abs(markerLatLng.lng - foundCity.lng) < 0.001) {
                            marker.openPopup();
                        }
                    });
                }, 500); // Cluster a√ßƒ±lmasƒ± i√ßin kƒ±sa bir gecikme
            } else {
                alert(`"${searchTerm}" ili bulunamadƒ±. L√ºtfen farklƒ± bir il adƒ± deneyin.`);
            }
        }

        // Yƒ±l aralƒ±ƒüƒ± doƒürulama
        function validateYearRange() {
            const allYears = document.getElementById('allYears').checked;
            if (allYears) return true; // T√ºm√º se√ßiliyse doƒürulama yapma
            
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            
            if (!isNaN(startYear) && !isNaN(endYear) && startYear > endYear) {
                alert('Ba≈ülangƒ±√ß yƒ±lƒ±, biti≈ü yƒ±lƒ±ndan b√ºy√ºk olamaz!');
                document.getElementById('startYear').value = endYear;
                return false;
            }
            return true;
        }

        // Event listeners
        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
        document.getElementById('loadGithubData').addEventListener('click', loadGithubData);
        document.getElementById('searchBtn').addEventListener('click', searchCity);
        document.getElementById('citySearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCity();
            }
        });
        
        // "T√ºm√º" checkbox
        document.getElementById('allYears').addEventListener('change', function() {
            toggleYearInputs();
            filterData();
        });
        
        // Yƒ±l input'larƒ±nda deƒüi≈üiklik olduƒüunda "T√ºm√º"y√º kaldƒ±r
        document.getElementById('startYear').addEventListener('input', function() {
            if (this.value) {
                document.getElementById('allYears').checked = false;
                toggleYearInputs();
            }
        });
        
        document.getElementById('endYear').addEventListener('input', function() {
            if (this.value) {
                document.getElementById('allYears').checked = false;
                toggleYearInputs();
            }
        });
        
        // Yƒ±l filtresi uygulama butonu
        document.getElementById('applyYearFilter').addEventListener('click', function() {
            if (validateYearRange()) {
                filterData();
            }
        });
        
        // Yƒ±l inputlarƒ±nda Enter tu≈üu ile uygulama
        document.getElementById('startYear').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && validateYearRange()) {
                filterData();
            }
        });
        
        document.getElementById('endYear').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && validateYearRange()) {
                filterData();
            }
        });
        
        document.getElementById('sectorFilter').addEventListener('change', filterData);

        // Sayfa y√ºklendiƒüinde ba≈ülangƒ±√ß durumu
        toggleYearInputs();
        
        // ƒ∞lk y√ºkleme
        addMarkers(workplaceAccidents);
    </script>
</body>
</html>
